export const TRUCK_FEES = [
  { city: "í‰íƒì‹œ", fee1t: 50000, fee5t: 90000 },
  { city: "ì˜¤ì‚°ì‹œ", fee1t: 50000, fee5t: 90000 },
  { city: "ì•ˆì„±ì‹œ", fee1t: 64000, fee5t: 110000 },
  { city: "í™”ì„±ì‹œ", fee1t: 62000, fee5t: 110000 },
  { city: "ìˆ˜ì›ì‹œ", fee1t: 57000, fee5t: 110000 },
  { city: "ìš©ì¸ì‹œ", fee1t: 58000, fee5t: 110000 },
  { city: "ì•ˆì‚°ì‹œ", fee1t: 73000, fee5t: 130000 },
  { city: "ì‹œí¥ì‹œ", fee1t: 78000, fee5t: 140000 },
  { city: "ì„±ë‚¨ì‹œ", fee1t: 76000, fee5t: 130000 },
  { city: "ê´‘ëª…ì‹œ", fee1t: 86000, fee5t: 150000 },
  { city: "ë¶€ì²œì‹œ", fee1t: 90000, fee5t: 150000 },
  { city: "ê³¼ì²œì‹œ", fee1t: 79000, fee5t: 140000 },
  { city: "êµ°í¬ì‹œ", fee1t: 72000, fee5t: 130000 },
  { city: "ì˜ì™•ì‹œ", fee1t: 65000, fee5t: 120000 },
  { city: "ì•ˆì–‘ì‹œ", fee1t: 71000, fee5t: 130000 },
  { city: "ê¹€í¬ì‹œ", fee1t: 103000, fee5t: 170000 },
  { city: "ê³ ì–‘ì‹œ", fee1t: 104000, fee5t: 170000 },
  { city: "íŒŒì£¼ì‹œ", fee1t: 114000, fee5t: 190000 },
  { city: "ì´ì²œì‹œ", fee1t: 83000, fee5t: 140000 },
  { city: "ì—¬ì£¼ì‹œ", fee1t: 98000, fee5t: 170000 },
  { city: "ì–‘í‰êµ°", fee1t: 101000, fee5t: 170000 },
  { city: "í•˜ë‚¨ì‹œ", fee1t: 83000, fee5t: 140000 },
  { city: "ê´‘ì£¼ì‹œ(ê²½ê¸°)", fee1t: 79000, fee5t: 140000 },
  { city: "í¬ì²œì‹œ", fee1t: 128000, fee5t: 210000 },
  { city: "ì—°ì²œêµ°", fee1t: 152000, fee5t: 240000 },
  { city: "ê°€í‰êµ°", fee1t: 129000, fee5t: 210000 },
  { city: "ì„œìš¸ì‹œ", fee1t: 93000, fee5t: 160000 },
  { city: "ì¸ì²œì‹œ", fee1t: 91000, fee5t: 160000 },
  { city: "ì²œì•ˆì‹œ", fee1t: 73000, fee5t: 130000 },
  { city: "ì•„ì‚°ì‹œ", fee1t: 75000, fee5t: 130000 },
  { city: "ë‹¹ì§„ì‹œ", fee1t: 84000, fee5t: 140000 },
  { city: "ì„œì‚°ì‹œ", fee1t: 102000, fee5t: 170000 },
  { city: "íƒœì•ˆêµ°", fee1t: 118000, fee5t: 190000 },
  { city: "ì˜ˆì‚°êµ°", fee1t: 88000, fee5t: 150000 },
  { city: "í™ì„±êµ°", fee1t: 102000, fee5t: 170000 },
  { city: "ë³´ë ¹ì‹œ", fee1t: 131000, fee5t: 210000 },
  { city: "ì²­ì£¼ì‹œ", fee1t: 99000, fee5t: 170000 },
  { city: "ì„¸ì¢…ì‹œ", fee1t: 107000, fee5t: 180000 },
  { city: "ëŒ€ì „ì‹œ", fee1t: 120000, fee5t: 200000 },
  { city: "ë…¼ì‚°ì‹œ", fee1t: 132000, fee5t: 210000 },
  { city: "ê³„ë£¡ì‹œ", fee1t: 130000, fee5t: 210000 },
  { city: "ê³µì£¼ì‹œ", fee1t: 108000, fee5t: 180000 },
  { city: "ë¶€ì—¬êµ°", fee1t: 130000, fee5t: 210000 },
  { city: "ê¸ˆì‚°êµ°", fee1t: 150000, fee5t: 240000 },
  { city: "ì œì²œì‹œ", fee1t: 131000, fee5t: 210000 },
  { city: "ì¶©ì£¼ì‹œ", fee1t: 112000, fee5t: 180000 },
  { city: "ë‹¨ì–‘êµ°", fee1t: 145000, fee5t: 230000 },
  { city: "ì „ì£¼ì‹œ", fee1t: 166000, fee5t: 260000 },
  { city: "ìµì‚°ì‹œ", fee1t: 155000, fee5t: 250000 },
  { city: "êµ°ì‚°ì‹œ", fee1t: 156000, fee5t: 250000 },
  { city: "ê¹€ì œì‹œ", fee1t: 169000, fee5t: 270000 },
  { city: "ì •ìì‹œ", fee1t: 191000, fee5t: 290000 },
  { city: "ë‚¨ì›ì‹œ", fee1t: 206000, fee5t: 310000 },
  { city: "ê´‘ì£¼ê´‘ì—­ì‹œ", fee1t: 229000, fee5t: 340000 },
  { city: "ë‚˜ì£¼ì‹œ", fee1t: 243000, fee5t: 360000 },
  { city: "ëª©í¬ì‹œ", fee1t: 267000, fee5t: 390000 },
  { city: "í•´ë‚¨êµ°", fee1t: 290000, fee5t: 430000 },
  { city: "ì™„ë„êµ°", fee1t: 318000, fee5t: 470000 },
  { city: "ì—¬ìˆ˜ì‹œ", fee1t: 270000, fee5t: 400000 },
  { city: "ìˆœì²œì‹œ", fee1t: 250000, fee5t: 370000 },
  { city: "ê´‘ì–‘ì‹œ", fee1t: 254000, fee5t: 370000 },
  { city: "ëŒ€êµ¬ê´‘ì—­ì‹œ", fee1t: 210000, fee5t: 320000 },
  { city: "êµ¬ë¯¸ì‹œ", fee1t: 179000, fee5t: 270000 },
  { city: "ê¹€ì²œì‹œ", fee1t: 166000, fee5t: 260000 },
  { city: "ì•ˆë™ì‹œ", fee1t: 181000, fee5t: 280000 },
  { city: "ì˜ì£¼ì‹œ", fee1t: 172000, fee5t: 260000 },
  { city: "ë¬¸ê²½ì‹œ", fee1t: 153000, fee5t: 240000 },
  { city: "í¬í•­ì‹œ", fee1t: 245000, fee5t: 360000 },
  { city: "ê²½ì£¼ì‹œ", fee1t: 246000, fee5t: 360000 },
  { city: "ìš¸ì‚°ê´‘ì—­ì‹œ", fee1t: 270000, fee5t: 400000 },
  { city: "ë¶€ì‚°ê´‘ì—­ì‹œ", fee1t: 282000, fee5t: 410000 },
  { city: "ì°½ì›ì‹œ", fee1t: 260000, fee5t: 380000 },
  { city: "ê¹€í•´ì‹œ", fee1t: 269000, fee5t: 400000 },
  { city: "ì§„ì£¼ì‹œ", fee1t: 242000, fee5t: 360000 },
  { city: "ì‚¬ì²œì‹œ", fee1t: 257000, fee5t: 380000 },
  { city: "í†µì˜ì‹œ", fee1t: 281000, fee5t: 410000 },
  { city: "ê±°ì œì‹œ", fee1t: 285000, fee5t: 420000 },
];

// ===== ì ì¬ ì•Œê³ ë¦¬ì¦˜ =====

interface CartItemForTruck {
  category?: "flashing" | "swing" | "hanga";
  productName: string;
  size: string;
  qty: number;
}

// í–‰ê°€ë„ì–´ ì‚¬ì´ì¦ˆì—ì„œ ê°€ë¡œì„¸ë¡œ(mm) ì¶”ì¶œ
function parseHangaSize(size: string): { w: number; h: number } {
  const match = size.match(/(\d+)Ã—(\d+)/);
  if (!match) return { w: 0, h: 0 };
  return { w: parseInt(match[1]), h: parseInt(match[2]) };
}

// í¸ê°œ í™˜ì‚° ìˆ˜ëŸ‰ ê³„ì‚°
function toPanels(item: CartItemForTruck): number {
  const isDouble = item.productName.includes("ì–‘ê°œ");
  return isDouble ? item.qty * 2 : item.qty;
}

export interface TruckResult {
  type: "self" | "parcel" | "1t" | "5t" | "combo" | "inquiry";
  label: string;
  desc: string;
  fee1t: number;
  fee5t: number;
  trucks: { size: "1t" | "5t"; count: number }[];
  totalFee: number;
  warning?: string;
}

// 1í†¤ í–‰ê°€ ì ì¬ í•œë„ (í¸ê°œ ê¸°ì¤€)
function hanga1tLimit(items: CartItemForTruck[]): { limit: number; ok: boolean; reason?: string } {
  const hangaItems = items.filter(i => i.category === "hanga");
  if (hangaItems.length === 0) return { limit: 0, ok: true };

  // ì œì¼ í° ì‚¬ì´ì¦ˆ ê¸°ì¤€ (ì–‘ê°œë©´ í­/2 = í•œ ì§ ê¸°ì¤€)
  let maxMinSide = 0;
  let maxMaxSide = 0;
  for (const item of hangaItems) {
    const { w, h } = parseHangaSize(item.size);
    const isDouble = item.productName.includes("ì–‘ê°œ");
    const actualW = isDouble ? Math.ceil(w / 2) : w;
    const minS = Math.min(actualW, h);
    const maxS = Math.max(actualW, h);
    if (minS > maxMinSide) maxMinSide = minS;
    if (maxS > maxMaxSide) maxMaxSide = maxS;
  }

  if (maxMinSide <= 1500 && maxMaxSide <= 3000) return { limit: 8, ok: true };
  if (maxMinSide <= 2000 && maxMaxSide <= 3000) return { limit: 2, ok: true };
  return { limit: 0, ok: false, reason: "í–‰ê°€ë„ì–´ ì‚¬ì´ì¦ˆê°€ 1í†¤ì— ì ì¬ ë¶ˆê°€í•©ë‹ˆë‹¤" };
}

// 5í†¤ í–‰ê°€ ì ì¬ í•œë„ (í¸ê°œ ê¸°ì¤€)
function hanga5tLimit(items: CartItemForTruck[]): { limit: number; ok: boolean; inquiry?: boolean; reason?: string } {
  const hangaItems = items.filter(i => i.category === "hanga");
  if (hangaItems.length === 0) return { limit: 0, ok: true };

  let maxMinSide = 0;
  let maxMaxSide = 0;
  for (const item of hangaItems) {
    const { w, h } = parseHangaSize(item.size);
    const isDouble = item.productName.includes("ì–‘ê°œ");
    const actualW = isDouble ? Math.ceil(w / 2) : w;
    const minS = Math.min(actualW, h);
    const maxS = Math.max(actualW, h);
    if (minS > maxMinSide) maxMinSide = minS;
    if (maxS > maxMaxSide) maxMaxSide = maxS;
  }

  if (maxMinSide <= 2400 && maxMaxSide <= 6000) return { limit: 6, ok: true };
  return { limit: 0, ok: false, inquiry: true, reason: "í–‰ê°€ë„ì–´ 2500Ã—6000 ì´ìƒ ì‚¬ì´ì¦ˆëŠ” ë³„ë„ ë¬¸ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤" };
}

export function calcTruckOptions(items: CartItemForTruck[], regionCity: string): TruckResult[] {
  const region = TRUCK_FEES.find(r => r.city === regionCity);
  const fee1t = region?.fee1t ?? 0;
  const fee5t = region?.fee5t ?? 0;

  const flashingQty = items.filter(i => i.category === "flashing").reduce((s, i) => s + i.qty, 0);
  const swingPanels = items.filter(i => i.category === "swing").reduce((s, i) => s + toPanels(i), 0);
  const hangaPanels = items.filter(i => i.category === "hanga").reduce((s, i) => s + toPanels(i), 0);
  const hasHanga = hangaPanels > 0;
  const hasSwing = swingPanels > 0;
  const hasFlashing = flashingQty > 0;

  const results: TruckResult[] = [];

  // ===== 1í†¤ ì²´í¬ =====
  const h1 = hanga1tLimit(items);

  if (hasHanga) {
    // í–‰ê°€ ìˆì„ ë•Œ: í–‰ê°€ ì ì¬ ê°€ëŠ¥ ì—¬ë¶€ + ì§œíˆ¬ë¦¬(ìŠ¤ìœ™2, í›„ë ˆì‹±40)
    if (h1.ok && hangaPanels <= h1.limit && swingPanels <= 2 && flashingQty <= 40) {
      results.push({
        type: "1t", label: "ğŸš› 1í†¤ ìš©ì°¨", desc: `í–‰ê°€${hangaPanels}ì§${hasSwing ? `+ìŠ¤ìœ™${swingPanels}ì¡°` : ""}${hasFlashing ? `+í›„ë ˆì‹±${flashingQty}ê°œ` : ""}`,
        fee1t, fee5t, trucks: [{ size: "1t", count: 1 }], totalFee: fee1t,
      });
    }
  } else if (hasSwing) {
    // ìŠ¤ìœ™+í›„ë ˆì‹±: ìŠ¤ìœ™18 + í›„ë ˆì‹±80
    if (swingPanels <= 18 && flashingQty <= 80) {
      results.push({
        type: "1t", label: "ğŸš› 1í†¤ ìš©ì°¨", desc: `ìŠ¤ìœ™${swingPanels}ì¡°${hasFlashing ? `+í›„ë ˆì‹±${flashingQty}ê°œ` : ""}`,
        fee1t, fee5t, trucks: [{ size: "1t", count: 1 }], totalFee: fee1t,
      });
    }
  } else if (hasFlashing) {
    // í›„ë ˆì‹±ë§Œ: 200ê°œ
    if (flashingQty <= 200) {
      results.push({
        type: "1t", label: "ğŸš› 1í†¤ ìš©ì°¨", desc: `í›„ë ˆì‹± ${flashingQty}ê°œ`,
        fee1t, fee5t, trucks: [{ size: "1t", count: 1 }], totalFee: fee1t,
      });
    }
  }

  // ===== 5í†¤ ì²´í¬ =====
  const h5 = hanga5tLimit(items);

  if (h5.inquiry) {
    // 2500Ã—6000 ì´ìƒ â†’ ë¬¸ì˜
    results.push({
      type: "inquiry", label: "ğŸ“ ë³„ë„ ë¬¸ì˜", desc: h5.reason || "",
      fee1t, fee5t, trucks: [], totalFee: 0, warning: h5.reason,
    });
    return results; // ë¬¸ì˜ í•„ìš”í•˜ë©´ ë‹¤ë¥¸ ì˜µì…˜ ë¶ˆí•„ìš”
  }

  if (hasHanga) {
    if (h5.ok && hangaPanels <= h5.limit && swingPanels <= 2 && flashingQty <= 40) {
      results.push({
        type: "5t", label: "ğŸš› 5í†¤ ìš©ì°¨", desc: `í–‰ê°€${hangaPanels}ì§${hasSwing ? `+ìŠ¤ìœ™${swingPanels}ì¡°` : ""}${hasFlashing ? `+í›„ë ˆì‹±${flashingQty}ê°œ` : ""}`,
        fee1t, fee5t, trucks: [{ size: "5t", count: 1 }], totalFee: fee5t,
      });
    } else if (h5.ok) {
      // 5í†¤ 1ëŒ€ë¡œ ì•ˆ ë˜ë©´ ì¡°í•©
      const need5t = Math.ceil(hangaPanels / h5.limit);
      // ë‚˜ë¨¸ì§€(ìŠ¤ìœ™/í›„ë ˆì‹±)ëŠ” 1í†¤ ì¶”ê°€
      const needExtra1t = (swingPanels > 2 || flashingQty > 40) ? 1 : 0;
      results.push({
        type: "combo", label: `ğŸš› 5í†¤Ã—${need5t}${needExtra1t ? "+1í†¤Ã—1" : ""}`, desc: "ì ì¬ëŸ‰ ì´ˆê³¼ë¡œ ë³µìˆ˜ ì°¨ëŸ‰ í•„ìš”",
        fee1t, fee5t, trucks: [{ size: "5t", count: need5t }, ...(needExtra1t ? [{ size: "1t" as const, count: 1 }] : [])],
        totalFee: fee5t * need5t + fee1t * needExtra1t,
      });
    }
  } else if (hasSwing) {
    if (swingPanels <= 72 && flashingQty <= 80) {
      results.push({
        type: "5t", label: "ğŸš› 5í†¤ ìš©ì°¨", desc: `ìŠ¤ìœ™${swingPanels}ì¡°${hasFlashing ? `+í›„ë ˆì‹±${flashingQty}ê°œ` : ""}`,
        fee1t, fee5t, trucks: [{ size: "5t", count: 1 }], totalFee: fee5t,
      });
    } else {
      // ì´ˆê³¼ â†’ 5+1 ë˜ëŠ” 5+5
      const need5tSwing = Math.ceil(swingPanels / 72);
      const remainFlashing = flashingQty > 80 ? flashingQty - 80 : 0;
      const need1tFlashing = remainFlashing > 0 ? Math.ceil(remainFlashing / 200) : 0;
      results.push({
        type: "combo", label: `ğŸš› 5í†¤Ã—${need5tSwing}${need1tFlashing ? `+1í†¤Ã—${need1tFlashing}` : ""}`,
        desc: "ì ì¬ëŸ‰ ì´ˆê³¼ë¡œ ë³µìˆ˜ ì°¨ëŸ‰ í•„ìš”",
        fee1t, fee5t, trucks: [{ size: "5t", count: need5tSwing }, ...(need1tFlashing ? [{ size: "1t" as const, count: need1tFlashing }] : [])],
        totalFee: fee5t * need5tSwing + fee1t * need1tFlashing,
      });
    }
  } else if (hasFlashing) {
    if (flashingQty <= 800) {
      results.push({
        type: "5t", label: "ğŸš› 5í†¤ ìš©ì°¨", desc: `í›„ë ˆì‹± ${flashingQty}ê°œ`,
        fee1t, fee5t, trucks: [{ size: "5t", count: 1 }], totalFee: fee5t,
      });
    } else {
      const need5t = Math.ceil(flashingQty / 800);
      results.push({
        type: "combo", label: `ğŸš› 5í†¤Ã—${need5t}`, desc: "ì ì¬ëŸ‰ ì´ˆê³¼ë¡œ ë³µìˆ˜ ì°¨ëŸ‰ í•„ìš”",
        fee1t, fee5t, trucks: [{ size: "5t", count: need5t }],
        totalFee: fee5t * need5t,
      });
    }
  }

  return results;
}
