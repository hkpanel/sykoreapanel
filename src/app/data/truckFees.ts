export const TRUCK_FEES = [
  { city: "í‰íƒì‹œ", fee1t: 50000, fee5t: 90000 },
  { city: "ì˜¤ì‚°ì‹œ", fee1t: 50000, fee5t: 90000 },
  { city: "ì•ˆì„±ì‹œ", fee1t: 64000, fee5t: 110000 },
  { city: "í™”ì„±ì‹œ", fee1t: 62000, fee5t: 110000 },
  { city: "ìˆ˜ì›ì‹œ", fee1t: 57000, fee5t: 110000 },
  { city: "ìš©ì¸ì‹œ", fee1t: 58000, fee5t: 110000 },
  { city: "ì•ˆì‚°ì‹œ", fee1t: 73000, fee5t: 130000 },
  { city: "ì‹œí¥ì‹œ", fee1t: 78000, fee5t: 140000 },
  { city: "ì„±ë‚¨ì‹œ", fee1t: 76000, fee5t: 130000 },
  { city: "ê´‘ëª…ì‹œ", fee1t: 86000, fee5t: 150000 },
  { city: "ë¶€ì²œì‹œ", fee1t: 90000, fee5t: 150000 },
  { city: "ê³¼ì²œì‹œ", fee1t: 79000, fee5t: 140000 },
  { city: "êµ°í¬ì‹œ", fee1t: 72000, fee5t: 130000 },
  { city: "ì˜ì™•ì‹œ", fee1t: 65000, fee5t: 120000 },
  { city: "ì•ˆì–‘ì‹œ", fee1t: 71000, fee5t: 130000 },
  { city: "ê¹€í¬ì‹œ", fee1t: 103000, fee5t: 170000 },
  { city: "ê³ ì–‘ì‹œ", fee1t: 104000, fee5t: 170000 },
  { city: "íŒŒì£¼ì‹œ", fee1t: 114000, fee5t: 190000 },
  { city: "ì´ì²œì‹œ", fee1t: 83000, fee5t: 140000 },
  { city: "ì—¬ì£¼ì‹œ", fee1t: 98000, fee5t: 170000 },
  { city: "ì–‘í‰êµ°", fee1t: 101000, fee5t: 170000 },
  { city: "í•˜ë‚¨ì‹œ", fee1t: 83000, fee5t: 140000 },
  { city: "ê´‘ì£¼ì‹œ(ê²½ê¸°)", fee1t: 79000, fee5t: 140000 },
  { city: "í¬ì²œì‹œ", fee1t: 128000, fee5t: 210000 },
  { city: "ì—°ì²œêµ°", fee1t: 152000, fee5t: 240000 },
  { city: "ê°€í‰êµ°", fee1t: 129000, fee5t: 210000 },
  { city: "ì„œìš¸ì‹œ", fee1t: 93000, fee5t: 160000 },
  { city: "ì¸ì²œì‹œ", fee1t: 91000, fee5t: 160000 },
  { city: "ì²œì•ˆì‹œ", fee1t: 73000, fee5t: 130000 },
  { city: "ì•„ì‚°ì‹œ", fee1t: 75000, fee5t: 130000 },
  { city: "ë‹¹ì§„ì‹œ", fee1t: 84000, fee5t: 140000 },
  { city: "ì„œì‚°ì‹œ", fee1t: 102000, fee5t: 170000 },
  { city: "íƒœì•ˆêµ°", fee1t: 118000, fee5t: 190000 },
  { city: "ì˜ˆì‚°êµ°", fee1t: 88000, fee5t: 150000 },
  { city: "í™ì„±êµ°", fee1t: 102000, fee5t: 170000 },
  { city: "ë³´ë ¹ì‹œ", fee1t: 131000, fee5t: 210000 },
  { city: "ì²­ì£¼ì‹œ", fee1t: 99000, fee5t: 170000 },
  { city: "ì„¸ì¢…ì‹œ", fee1t: 107000, fee5t: 180000 },
  { city: "ëŒ€ì „ì‹œ", fee1t: 120000, fee5t: 200000 },
  { city: "ë…¼ì‚°ì‹œ", fee1t: 132000, fee5t: 210000 },
  { city: "ê³„ë£¡ì‹œ", fee1t: 130000, fee5t: 210000 },
  { city: "ê³µì£¼ì‹œ", fee1t: 108000, fee5t: 180000 },
  { city: "ë¶€ì—¬êµ°", fee1t: 130000, fee5t: 210000 },
  { city: "ê¸ˆì‚°êµ°", fee1t: 150000, fee5t: 240000 },
  { city: "ì œì²œì‹œ", fee1t: 131000, fee5t: 210000 },
  { city: "ì¶©ì£¼ì‹œ", fee1t: 112000, fee5t: 180000 },
  { city: "ë‹¨ì–‘êµ°", fee1t: 145000, fee5t: 230000 },
  { city: "ì „ì£¼ì‹œ", fee1t: 166000, fee5t: 260000 },
  { city: "ìµì‚°ì‹œ", fee1t: 155000, fee5t: 250000 },
  { city: "êµ°ì‚°ì‹œ", fee1t: 156000, fee5t: 250000 },
  { city: "ê¹€ì œì‹œ", fee1t: 169000, fee5t: 270000 },
  { city: "ì •ìì‹œ", fee1t: 191000, fee5t: 290000 },
  { city: "ë‚¨ì›ì‹œ", fee1t: 206000, fee5t: 310000 },
  { city: "ê´‘ì£¼ê´‘ì—­ì‹œ", fee1t: 229000, fee5t: 340000 },
  { city: "ë‚˜ì£¼ì‹œ", fee1t: 243000, fee5t: 360000 },
  { city: "ëª©í¬ì‹œ", fee1t: 267000, fee5t: 390000 },
  { city: "í•´ë‚¨êµ°", fee1t: 290000, fee5t: 430000 },
  { city: "ì™„ë„êµ°", fee1t: 318000, fee5t: 470000 },
  { city: "ì—¬ìˆ˜ì‹œ", fee1t: 270000, fee5t: 400000 },
  { city: "ìˆœì²œì‹œ", fee1t: 250000, fee5t: 370000 },
  { city: "ê´‘ì–‘ì‹œ", fee1t: 254000, fee5t: 370000 },
  { city: "ëŒ€êµ¬ê´‘ì—­ì‹œ", fee1t: 210000, fee5t: 320000 },
  { city: "êµ¬ë¯¸ì‹œ", fee1t: 179000, fee5t: 270000 },
  { city: "ê¹€ì²œì‹œ", fee1t: 166000, fee5t: 260000 },
  { city: "ì•ˆë™ì‹œ", fee1t: 181000, fee5t: 280000 },
  { city: "ì˜ì£¼ì‹œ", fee1t: 172000, fee5t: 260000 },
  { city: "ë¬¸ê²½ì‹œ", fee1t: 153000, fee5t: 240000 },
  { city: "í¬í•­ì‹œ", fee1t: 245000, fee5t: 360000 },
  { city: "ê²½ì£¼ì‹œ", fee1t: 246000, fee5t: 360000 },
  { city: "ìš¸ì‚°ê´‘ì—­ì‹œ", fee1t: 270000, fee5t: 400000 },
  { city: "ë¶€ì‚°ê´‘ì—­ì‹œ", fee1t: 282000, fee5t: 410000 },
  { city: "ì°½ì›ì‹œ", fee1t: 260000, fee5t: 380000 },
  { city: "ê¹€í•´ì‹œ", fee1t: 269000, fee5t: 400000 },
  { city: "ì§„ì£¼ì‹œ", fee1t: 242000, fee5t: 360000 },
  { city: "ì‚¬ì²œì‹œ", fee1t: 257000, fee5t: 380000 },
  { city: "í†µì˜ì‹œ", fee1t: 281000, fee5t: 410000 },
  { city: "ê±°ì œì‹œ", fee1t: 285000, fee5t: 420000 },
];

// ===== ì ì¬ ì•Œê³ ë¦¬ì¦˜ (v2 â€” ì‹¤ì „ ì ì¬ ê·œì¹™ ê¸°ë°˜) =====

interface CartItemForTruck {
  category?: "flashing" | "swing" | "hanga";
  productName: string;
  size: string;
  qty: number;
}

// í–‰ê°€ë„ì–´ ì‚¬ì´ì¦ˆì—ì„œ ê°€ë¡œì„¸ë¡œ(mm) ì¶”ì¶œ
function parseHangaSize(size: string): { w: number; h: number } {
  const match = size.match(/(\d+)Ã—(\d+)/);
  if (!match) return { w: 0, h: 0 };
  return { w: parseInt(match[1]), h: parseInt(match[2]) };
}

// í¸ê°œ í™˜ì‚° ìˆ˜ëŸ‰ ê³„ì‚°
function toPanels(item: CartItemForTruck): number {
  const isDouble = item.productName.includes("ì–‘ê°œ");
  return isDouble ? item.qty * 2 : item.qty;
}

export interface TruckResult {
  type: "self" | "parcel" | "1t" | "5t" | "combo" | "inquiry";
  label: string;
  desc: string;
  fee1t: number;
  fee5t: number;
  trucks: { size: "1t" | "5t"; count: number }[];
  totalFee: number;
  warning?: string;
}

// í–‰ê°€ë„ì–´ ìµœëŒ€ í•œì§í­/ì§§ì€ë³€ ê³„ì‚°
function getHangaMaxDimensions(items: CartItemForTruck[]): { maxLeafW: number; maxMinSide: number } {
  let maxLeafW = 0;
  let maxMinSide = 0;
  for (const item of items.filter(i => i.category === "hanga")) {
    const { w, h } = parseHangaSize(item.size);
    const isDouble = item.productName.includes("ì–‘ê°œ");
    const leafW = isDouble ? Math.ceil(w / 2) : w;
    const minSide = Math.min(leafW, h);
    if (leafW > maxLeafW) maxLeafW = leafW;
    if (minSide > maxMinSide) maxMinSide = minSide;
  }
  return { maxLeafW, maxMinSide };
}

// â”€â”€ 1í†¤ í–‰ê°€ ì ì¬ í•œë„ (í•œì§í­ ê¸°ì¤€) â”€â”€
function hanga1tLimit(maxLeafW: number): number {
  if (maxLeafW <= 1500) return 4;
  if (maxLeafW <= 2000) return 2;
  if (maxLeafW <= 2500) return 1;
  return 0; // 2500 ì´ˆê³¼ â†’ 1í†¤ ë¶ˆê°€
}

// â”€â”€ 5í†¤ í–‰ê°€ ì ì¬ í•œë„ (2ë‹¨Ã—6 = 12ì§) â”€â”€
const HANGA_5T_LIMIT = 12;

export function calcTruckOptions(items: CartItemForTruck[], regionCity: string): TruckResult[] {
  const region = TRUCK_FEES.find(r => r.city === regionCity);
  const fee1t = region?.fee1t ?? 0;
  const fee5t = region?.fee5t ?? 0;

  const flashingQty = items.filter(i => i.category === "flashing").reduce((s, i) => s + i.qty, 0);
  const swingPanels = items.filter(i => i.category === "swing").reduce((s, i) => s + toPanels(i), 0);
  const hangaPanels = items.filter(i => i.category === "hanga").reduce((s, i) => s + toPanels(i), 0);
  const hasHanga = hangaPanels > 0;
  const hasSwing = swingPanels > 0;
  const hasFlashing = flashingQty > 0;

  const { maxLeafW, maxMinSide } = getHangaMaxDimensions(items);

  const results: TruckResult[] = [];

  // â”â”â” ì§§ì€ë³€ > 3000mm â†’ ìš©ì°¨ ìì²´ ë¶ˆê°€ â”â”â”
  if (hasHanga && maxMinSide > 3000) {
    results.push({
      type: "inquiry", label: "âš ï¸ ê°€ì¡°ë¦½/í˜„ì¥ì œì‘",
      desc: "ì§§ì€ë³€ì´ 3000mmë¥¼ ì´ˆê³¼í•˜ì—¬ ì™„ì¡°ë¦½ ìš©ì°¨ ë°°ì†¡ì´ ë¶ˆê°€í•©ë‹ˆë‹¤. ê°€ì¡°ë¦½ ë˜ëŠ” í˜„ì¥ì œì‘ìœ¼ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”.",
      fee1t, fee5t, trucks: [], totalFee: 0,
      warning: "ì§§ì€ë³€ 3000mm ì´ˆê³¼ â€” ê°€ì¡°ë¦½/í˜„ì¥ì œì‘ í•„ìš”",
    });
    return results;
  }

  // â”â”â” 1í†¤ ì ì¬ íŒì • â”â”â”
  const h1Limit = hasHanga ? hanga1tLimit(maxLeafW) : 0;
  const desc1 = (parts: string[]) => parts.filter(Boolean).join(" + ");

  if (hasHanga) {
    // í–‰ê°€ + (ìŠ¤ìœ™/í›„ë ˆì‹±)
    if (h1Limit > 0 && hangaPanels <= h1Limit) {
      // í–‰ê°€ê°€ ì ˆë°˜ ì´í•˜ë©´ ì—¬ìœ , ì ˆë°˜ ì´ˆê³¼ë©´ ë¹¡ë¹¡
      const halfFull = hangaPanels > h1Limit * 0.5;
      const swingRemain = halfFull ? 3 : 4;
      // í›„ë ˆì‹±ì€ ì‘ì•„ì„œ ì•„ë˜ì— ê¹” ìˆ˜ ìˆìœ¼ë¯€ë¡œ í•­ìƒ 100ê°œê¹Œì§€
      const flashRemain = 100;

      if (swingPanels <= swingRemain && flashingQty <= flashRemain) {
        results.push({
          type: "1t", label: "ğŸš› 1í†¤ ìš©ì°¨",
          desc: desc1([`í–‰ê°€ ${hangaPanels}ì§`, hasSwing ? `ìŠ¤ìœ™ ${swingPanels}ì¡°` : "", hasFlashing ? `í›„ë ˆì‹± ${flashingQty}ê°œ` : ""]),
          fee1t, fee5t, trucks: [{ size: "1t", count: 1 }], totalFee: fee1t,
        });
      }
    }
  } else if (hasSwing) {
    // ìŠ¤ìœ™ only (+ í›„ë ˆì‹±: ìŠ¤ìœ™ ì—¬ìœ ë¶„ì— ë¹„ë¡€)
    const swingUsage = swingPanels / 20; // 0~1
    const flashRemain = swingUsage <= 0.5 ? 150 : 40;
    if (swingPanels <= 20 && flashingQty <= flashRemain) {
      results.push({
        type: "1t", label: "ğŸš› 1í†¤ ìš©ì°¨",
        desc: desc1([`ìŠ¤ìœ™ ${swingPanels}ì¡°`, hasFlashing ? `í›„ë ˆì‹± ${flashingQty}ê°œ` : ""]),
        fee1t, fee5t, trucks: [{ size: "1t", count: 1 }], totalFee: fee1t,
      });
    }
  } else if (hasFlashing) {
    // í›„ë ˆì‹± only
    if (flashingQty <= 300) {
      results.push({
        type: "1t", label: "ğŸš› 1í†¤ ìš©ì°¨",
        desc: `í›„ë ˆì‹± ${flashingQty}ê°œ`,
        fee1t, fee5t, trucks: [{ size: "1t", count: 1 }], totalFee: fee1t,
      });
    }
  }

  // â”â”â” 5í†¤ ì ì¬ íŒì • â”â”â”
  if (hasHanga) {
    if (hangaPanels <= HANGA_5T_LIMIT) {
      // 5í†¤ 1ëŒ€: ì•ì—´ í–‰ê°€, ë’·ì—´ ìŠ¤ìœ™/í›„ë ˆì‹±
      const frontUsed = hangaPanels > 6; // ì•ì—´ ë„˜ì–´ì„œ ë’·ì—´ê¹Œì§€ í–‰ê°€
      const swingRemain5 = frontUsed ? 0 : 32;
      const flashRemain5 = frontUsed ? 0 : 300;

      if (swingPanels <= swingRemain5 && flashingQty <= flashRemain5) {
        results.push({
          type: "5t", label: "ğŸš› 5í†¤ ìš©ì°¨",
          desc: desc1([`í–‰ê°€ ${hangaPanels}ì§`, hasSwing ? `ìŠ¤ìœ™ ${swingPanels}ì¡°` : "", hasFlashing ? `í›„ë ˆì‹± ${flashingQty}ê°œ` : ""]),
          fee1t, fee5t, trucks: [{ size: "5t", count: 1 }], totalFee: fee5t,
        });
      } else {
        // 5í†¤ 1ëŒ€ë¡œ ë¶€ì¡± â†’ 5í†¤ + 1í†¤ ì¡°í•©
        const extra1t = 1;
        results.push({
          type: "combo", label: "ğŸš› 5í†¤Ã—1 + 1í†¤Ã—1",
          desc: "í–‰ê°€ëŠ” 5í†¤, ë‚˜ë¨¸ì§€ëŠ” 1í†¤ ë¶„ë¦¬ ë°°ì†¡",
          fee1t, fee5t, trucks: [{ size: "5t", count: 1 }, { size: "1t", count: extra1t }],
          totalFee: fee5t + fee1t * extra1t,
        });
      }
    } else {
      // í–‰ê°€ë§Œìœ¼ë¡œ 5í†¤ ì´ˆê³¼ â†’ ë³µìˆ˜ 5í†¤
      const need5t = Math.ceil(hangaPanels / HANGA_5T_LIMIT);
      const needExtra = (swingPanels > 0 || flashingQty > 0) ? 1 : 0;
      results.push({
        type: "combo", label: `ğŸš› 5í†¤Ã—${need5t}${needExtra ? " + 1í†¤Ã—1" : ""}`,
        desc: "ì ì¬ëŸ‰ ì´ˆê³¼ë¡œ ë³µìˆ˜ ì°¨ëŸ‰ í•„ìš”",
        fee1t, fee5t, trucks: [{ size: "5t", count: need5t }, ...(needExtra ? [{ size: "1t" as const, count: 1 }] : [])],
        totalFee: fee5t * need5t + fee1t * needExtra,
      });
    }
  } else if (hasSwing) {
    // ìŠ¤ìœ™ (+ í›„ë ˆì‹±): ì•ì—´ ìŠ¤ìœ™, ë’·ì—´ í›„ë ˆì‹±
    const swingLimit5 = flashingQty > 0 ? 32 : 64;
    const flashLimit5 = swingPanels > 32 ? 0 : 300;

    if (swingPanels <= swingLimit5 && flashingQty <= flashLimit5) {
      results.push({
        type: "5t", label: "ğŸš› 5í†¤ ìš©ì°¨",
        desc: desc1([`ìŠ¤ìœ™ ${swingPanels}ì¡°`, hasFlashing ? `í›„ë ˆì‹± ${flashingQty}ê°œ` : ""]),
        fee1t, fee5t, trucks: [{ size: "5t", count: 1 }], totalFee: fee5t,
      });
    } else {
      const need5t = Math.ceil(swingPanels / 64);
      const needFlash1t = flashingQty > flashLimit5 ? Math.ceil(flashingQty / 300) : 0;
      results.push({
        type: "combo", label: `ğŸš› 5í†¤Ã—${need5t}${needFlash1t ? ` + 1í†¤Ã—${needFlash1t}` : ""}`,
        desc: "ì ì¬ëŸ‰ ì´ˆê³¼ë¡œ ë³µìˆ˜ ì°¨ëŸ‰ í•„ìš”",
        fee1t, fee5t, trucks: [{ size: "5t", count: need5t }, ...(needFlash1t ? [{ size: "1t" as const, count: needFlash1t }] : [])],
        totalFee: fee5t * need5t + fee1t * needFlash1t,
      });
    }
  } else if (hasFlashing) {
    // í›„ë ˆì‹± only
    if (flashingQty <= 1000) {
      results.push({
        type: "5t", label: "ğŸš› 5í†¤ ìš©ì°¨",
        desc: `í›„ë ˆì‹± ${flashingQty}ê°œ`,
        fee1t, fee5t, trucks: [{ size: "5t", count: 1 }], totalFee: fee5t,
      });
    } else {
      const need5t = Math.ceil(flashingQty / 1000);
      results.push({
        type: "combo", label: `ğŸš› 5í†¤Ã—${need5t}`,
        desc: "ì ì¬ëŸ‰ ì´ˆê³¼ë¡œ ë³µìˆ˜ ì°¨ëŸ‰ í•„ìš”",
        fee1t, fee5t, trucks: [{ size: "5t", count: need5t }],
        totalFee: fee5t * need5t,
      });
    }
  }

  return results;
}
